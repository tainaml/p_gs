{%extends 'home/layout/base.html' %}

{% load thumbor_tags %}
{% load profile_tags %}
{% load social_tags %}
{% load taxonomy_tags %}
{% load avatar_tags %}
{% load humanize %}

{% block title %}{{ question.title }} - Portal GSTI{% endblock %}

{% block content %}
    <main class="container main">
        <div>
            <ul class="box-share">
                <li class="comment-vote">
                    {% like_box question request.path "share-box" %}
                </li>
                <li data-toggle="tooltip" data-placement="auto right" data-original-title="Favoritar"><a data-url-login="{% url 'account:is_logged' %}" data-trigger="login" data-token="{{ csrf_token }}" data-action="favourite" data-action-type="icon" data-object="favourite-{{ question.id }}" data-url-check="{% url 'socialactions:acted' question.id 'question' 'favourite' %}" href="{% url 'socialactions:act-xhr' question.id 'question' 'favourite' %}?url_next={{ request.path|urlencode }}"><i class="gsticon gsticon-star"></i></a></li>
                <li data-toggle="tooltip" data-placement="auto right" data-original-title="Ver depois"><a data-url-login="{% url 'account:is_logged' %}" data-trigger="login" data-token="{{ csrf_token }}" data-action="see-later" data-action-type="icon" data-url-check="{% url 'socialactions:acted' question.id 'question' 'see-later' %}" data-object="see-later-{{ question.id }}" href="{% url 'socialactions:act-xhr' question.id 'question' 'see-later' %}?url_next={{ request.path|urlencode }}"><i class="gsticon gsticon-eye"></i></a></li>
                <li data-toggle="tooltip" data-placement="auto right" data-original-title="Sugerir"><a data-url-login="{% url 'account:is_logged' %}" data-trigger="login" data-token="{{ csrf_token }}" href="javascript:;" data-suggest-modal="true" data-content="question" data-object="{{ question.id }}" data-url="{% url 'socialactions:act-suggest' question.id 'question' %}"><i class="gsticon gsticon-paper-plane"></i></a></li>
            </ul>
            <div class="post-container">
                <article class="full-post">
                    {% if feed and feed.official %}
                        <div class="label-official-content label-tall"
                             data-toggle="tooltip"
                             data-original-title="ConteÃºdo Oficial"></div>
                    {% endif%}
                    <header class="post-header">
                        <div class="post-info">
                            <time datetime="{{ question.question_date|date:"m-d-Y" }}" itemprop="datePublished">
                                {{ question.question_date|naturaltime }}
                            </time>
                            <a href="javascript:;" data-toggle="dropdown"><i class="gsticon gsticon-gear"></i></a>
                            <div class="dropdown-menu">
                                <ul class="perfil-actions">
                                    {% if question.author == request.user %}
                                    <li><a data-url-login="{% url 'account:is_logged' %}" data-trigger="login" data-token="{{ csrf_token }}" href="{% url 'question:edit' question.id   %}"><i class="gsticon gsticon-edit"></i> Editar pergunta</a></li>
                                    {% endif %}
                                    <li><a data-url-login="{% url 'account:is_logged' %}" data-trigger="login" data-token="{{ csrf_token }}" data-action="see-later" data-action-type="text" data-action-text="Ver depois" data-action-text-alt="Desmarcar como visto" data-url-check="{% url 'socialactions:acted' question.id 'question' 'see-later' %}" data-object="see-later-{{ question.id }}" href="{% url 'socialactions:act-xhr' question.id 'question' 'see-later' %}?url_next={{ request.path|urlencode }}"><i class="gsticon gsticon-eye"></i> <span>Ver depois</span></a></li>
                                    <li><a data-url-login="{% url 'account:is_logged' %}" data-trigger="login" data-token="{{ csrf_token }}" data-action="favourite" data-action-type="text" data-action-text="Favoritar" data-action-text-alt="Favoritado" data-object="favourite-{{ question.id }}" data-url-check="{% url 'socialactions:acted' question.id 'question' 'favourite' %}" href="{% url 'socialactions:act-xhr' question.id 'question' 'favourite' %}?url_next={{ request.path|urlencode }}"><i class="gsticon gsticon-star"></i> <span>Favoritar</span></a></li>
                                    <li><a data-url-login="{% url 'account:is_logged' %}" data-trigger="login" data-token="{{ csrf_token }}" href="{% url 'complaint:report' 'question' question.id %}" data-report="true" data-async-module="click" data-async-target="#modal-report" data-async-method="get"><i class="gsticon gsticon-exclamation-triangle"></i> Denunciar</a></li>
                                </ul>
                            </div>
                        </div>
                        <a class="post-creator" href="{% url 'profile:show' question.author.username %}">
                            <img src="{% get_avatar question.author width=20 height=20 smart=False fit_in=False %}" alt="{{ question.author.get_full_name }}">
                            {{ question.author.get_full_name }}
                        </a>
                        <span class="label label-question">pergunta</span>
                        <h1 class="full-post-title">
                            {{ question.title }}
                        </h1>
                    </header>
                    <aside class="post-footer">
                        {% taxonomies question %}
                        <div class="post-toolbar pull-right">
                            <div class="post-count">
                                {% like_box question request.path "inline" %}
                            </div>
                            <a class="post-count-comments" href="#comments"><strong>{{ question.counter_answer }}</strong> Respostas</a>
                        </div>
                    </aside>
                    <div class="full-post-content">
                        <p>{{ question.description|safe }}</p>
                        <div class="post-advertising text-center">
                            <img class="img-responsive" src="http://placehold.it/728x90" alt="Propaganda">
                        </div>
                    </div>
                    <div class="full-post-share">
                        <h3>COMPARTILHE</h3>
                        <div class="addthis_sharing_toolbox"></div>
                    </div>
                </article>

                <div id="comments">{% profile_box question.author "horizontal" %}</div>

                <header class="area-title">
                    <h2 id="answers">Respostas</h2>
                </header>
                <div class="container-comments">
                    {% include 'question/partials/answer-create.html' with content_type='question' content_object_id=question.id %}
                </div>
{#                <div data-xhr-url="{% url "question:answer_list" %}?question_id={{ question.id }}" data-xhr id="container-answers" class="container-comments j-scroll">#}
{#                </div>#}
                <div class="container-comments" id="container-answers">
                    {%  include 'question/partials/list-answer.html' %}
                </div>
            </div>
            {% include "question/partials/question-sidebar-right.html" %}
        </div>
    </main>
{% endblock %}


{% block modals %}
    {{ block.super }}

    {% include "home/partials/modals/modal-confirmation.html" %}

{% endblock %}



{% block javascripts %}
    <script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-55e70ed11db7fa4e" async></script>
    <script>

        var functionOpenModalToDelete = function(e) {
            e.preventDefault();

            var $btn = $(e.currentTarget),
                $modal = $($btn.data("modal"));

            $modal.find("form").attr("action", $btn.data("url"));
            $modal.find("#item-id").val($btn.data("item"));
            $modal.find("#item-type").val($btn.data("type"));
            $modal.find("#title-item-to-remove").html($btn.data("title"));
            $modal.find(".loading-container").html("");
            $modal.find(".alert-container").html("");
            $modal.modal("show");
        };

        var functionAjaxSuccessDeleteItem = function(e, data) {
            var $this = $(this),
                $modal = $($this.closest(".modal.fade")),
                itemId = $modal.find("#item-id").val(),
                itemType = $modal.find("#item-type").val();

            $modal.modal("hide");
            $modal.find("form").attr("action", "");
            $modal.find("#item-id").val("");
            $modal.find("#item-type").val("");
            $modal.find("#title-item-to-remove").html("");
            $modal.find(".loading-container").html("");
            $modal.find(".alert-container").html("");

            $("#" + itemType + "-" + itemId).fadeOut("slow", function(){
                $(this).remove();
            });
        };

        var form_submit = function(event, data){
            var $form = $(this);

            var action = $form.data("toggle");
            var $div_to_update = $($form.data("update"));

            if (action=="append"){
                $div_to_update.append(data.template);
                $form[0].reset();
            }else if (action=="prepend"){
                $div_to_update.prepend(data.template);
                var $form_to_hide = $form.parent(".dropdown-content");
                if ($form_to_hide){
                    $form_to_hide.removeClass("open");
                }
                $form[0].reset();
            }else if (action=="replace"){
                $div_to_update.html(data.template);
            }
            var $subforms = $div_to_update.find("form[data-ajaxform=\"true\"]");
            $subforms.IdeiaAjaxForm();
            $subforms.on("ajaxform.success", form_submit);

            var $data_list = $div_to_update.find("div[data-xhr]");
            $data_list.renderList();
            refreshAsyncLike();

        };

        $.fn.renderList = function(){

            return $.each(this, function(){

                var $self = $(this);
                var url = $self.data('xhr-url');

                var $childs;

                var request = $.ajax({
                    url: url,
                    success: function(data){

                        var $element = $(data);
                        $element.appendTo($self);

                        var regex = /^data-list-([0-9]+)$/;
                        if (regex.test($self.attr('id'))) {
                            var $parentSelf = $self.parent('.comments-children');
                            if ($self.children().length > 0)
                                $parentSelf.removeClass('no-children');
                            else
                                $parentSelf.addClass('no-children');
                        }

                        $childs = $element.find('div[data-xhr-url]');
                        $self.jscroll({
                            loadingHtml: '<div class="load-async-preload"></div>',
                            contentSelect: "#" + $self.attr("id"),
                            nextSelector: "a[data-jscroll-next]",
                            autoTrigger: false,
                            callback: function(data){
                                var $div_jscroll = $(".jscroll-added");
                                var $jscroll_subforms = $div_jscroll.find("form[data-ajaxform=\"true\"]");
                                $jscroll_subforms.IdeiaAjaxForm();
                                $jscroll_subforms.on("ajaxform.success", form_submit);
                                $div_jscroll.removeClass("jscroll-added");
                            }
                        });
                        var $subforms = $element.find("form[data-ajaxform=\"true\"]");
                        $subforms.IdeiaAjaxForm();
                        $subforms.on("ajaxform.success", form_submit);

                        var async_like = $self.find('[data-async-like]');
                        async_like.IdeiaAsyncLike();
                        async_like.removeData("async-like");
                    },
                    complete: function(){
                        if($childs.length){
                            $childs.renderList();
                        }
                    }
                });

                refreshAsyncLike();
            });
        };

        $(function(){
            var xhr_contents = $("div[data-xhr]");
            xhr_contents.renderList();

            $("form[data-ajaxform=\"true\"]").on("ajaxform.success", form_submit);


            $("#confirmation-form").on("ajaxform.success", functionAjaxSuccessDeleteItem);
            $(document).on("click", "[data-delete-item=true]", functionOpenModalToDelete);

        });
</script>
{% endblock %}