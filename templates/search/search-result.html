{%extends 'home/layout/base.html' %}

{% block title %}Portal GSTI - Resultado da busca por Python{% endblock %}

{% block content %}
    <main class="container main">
        <div class="row">

            {% include "search/partials/search-sidebar-left.html" with local_context=request.path|cut:'/buscar'|cut:'/'|default:'all' %}

            <div class="col-lg-9 result-wrapper">

                {% if articles.object_list %}
                    <div class="result-container">
                        <header class="area-title">
                            <h2>Publicações</h2>
                        </header>
                        <div class="area-content">
                            <div class="row j-scroll-articles j-scroll-container-articles">
                                {% include "search/partials/search-articles.html" %}
                            </div>
                        </div>
                    </div>
                {% endif %}

                {% if communities.object_list %}
                    <div class="result-container">
                        <header class="area-title">
                            <h2>Comunidades</h2>
                        </header>

                        <div class="area-content">
                            {% block filters %}
                            <div id="form-search" class="filter row form-search filters-members" data-toggle="filters">
                            <form id="search-form" action="{% url 'search:list' "communities" %}" method="GET" data-type="html" data-ajaxform="true" data-group-class=".form-search-input">
                                <div class="col-lg-8 clearfix">
                                    <div class="form-search-input">
                                        <input type="text" id="fcommunity" name="q" placeholder="{{placehold|default:"Procure comunidades"}}" autocomplete="off" />
                                    </div>
                                    <button type="submit" id="search" class="form-search-button">
                                        <i class="gsticon gsticon-search"></i>
                                    </button>
                                </div>
                                <div class="col-lg-4 text-right">
                                    <div class="custom-select">
                                        <select data-url="{% url 'search:search-content' "communities" %}" id="cfilter" class="form-control" name="category">
                                            <option class="custom-select-option" value="">Selecione</option>
                                            {% for category in categories %}
                                                <option {% if request.GET.category == category.id|stringformat:"i" %}selected="selected"{% endif %} class="custom-select-option" value="{{ category.slug }}">{{ category.description }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </form>
                        </div>
                        {% endblock %}
                            <div class="row j-scroll-communities j-scroll-container-communities" id="communities-container">
                                {% include "search/partials/search-communities.html" %}
                            </div>
                        </div>
                    </div>
                {% endif %}

                {% if users.object_list %}
                    <div class="result-container">
                        <header class="area-title">
                            <h2>Pessoas</h2>
                        </header>
                        <div class="area-content">
                            <div class="row j-scroll-users j-scroll-container-users">
                                {% include "search/partials/search-users.html" %}
                            </div>
                        </div>
                    </div>
                {% endif %}

                {% if questions.object_list %}
                    <div class="result-container">
                        <header class="area-title">
                            <h2>Perguntas</h2>
                        </header>
                        <div class="area-content">
                            <div class="row j-scroll-questions j-scroll-container-questions">
                                {% include "search/partials/search-questions.html" %}
                            </div>
                        </div>
                    </div>
                {% endif %}

                {% if not articles.object_list and not communities.object_list and not users.object_list and not questions.object_list %}
                    {% comment %}
                    <div class="result-container">
                        <header class="area-title">
                            <h2>Perguntas</h2>
                        </header>
                        <div class="area-content">
                            <div class="row j-scroll-questions j-scroll-container-questions">
                            </div>
                        </div>
                    </div>
                    {% endcomment %}
                    <hr>
                    <p class="text-center">Nenhum resultado foi encontrado para a busca!</p>
                    <hr>
                {% endif %}

            </div>
        </div>
    </main>
{% endblock %}


{% block javascripts %}
    {{ block.super }}

    <script>
        var loaderHtml = '<div class="col-lg-12"><div class="load-async-preload"></div></div>';
        var callbackFunction = function() {
            refreshAsyncLike();
        };

        $(function() {
            $(".j-scroll-communities").jscroll({
                autoTrigger: false,
                loadingHtml: loaderHtml,
                contentSelect: ".j-scroll-container-communities",
                nextSelector: "a[data-jscroll-next-communities]",
                callback: callbackFunction
            });

            $(".j-scroll-users").jscroll({
                autoTrigger: false,
                loadingHtml: loaderHtml,
                contentSelect: ".j-scroll-container-user",
                nextSelector: "a[data-jscroll-next-users]",
                callback: callbackFunction
            });

            $(".j-scroll-articles").jscroll({
                autoTrigger: false,
                loadingHtml: loaderHtml,
                contentSelect: ".j-scroll-container-articles",
                nextSelector: "a[data-jscroll-next-articles]",
                callback: callbackFunction
            });

            $(".j-scroll-questions").jscroll({
                autoTrigger: false,
                loadingHtml: loaderHtml,
                contentSelect: ".j-scroll-container-questions",
                nextSelector: "a[data-jscroll-next-questions]",
                callback: callbackFunction
            });
        });

        var timeoutReference= null;
        var functionAjaxSuccessFilterCommunities = function(e, data) {

            var $divCommunities = $("#communities-container");
            var $divJScroll = $('<div />');
            $divJScroll.addClass('j-scroll-communities-container');

            $divJScroll.html(data);
            $divCommunities.html($divJScroll);
            $divJScroll.jscroll({
                autoTrigger: false,
                contentSelect: ".j-scroll-communities-container",
                loadingHtml: '<div class="load-async-preload"></div>',
                nextSelector: "a[data-jscroll-next-communities]",
                callback: callbackFunction
            });
        };

        $(function() {
            $(document).on('input', "#fcommunity", function (e) {
                var $this = $(e.currentTarget);

                if (e.type=='keyup' && e.keyCode!=8) return;
                if (timeoutReference) clearTimeout(timeoutReference);
                timeoutReference = setTimeout(function(){
                    $this.closest('form').submit();
                }, 500);
            });

            $(document).on('change', "#cfilter" , function(event) {

                var $this = $(event.currentTarget);
                var $form = $this.closest('form');
                var url = $this.data("url");
                url = url + "?" +$form.serialize();
                window.location.replace(url);
            });

            $("#search-form").on("ajaxform.success", functionAjaxSuccessFilterCommunities);

            var $social_count = $("[data-social-count=\"true\"]");
            $.each($social_count, function(key, value){
               var $obj = $(value);
                $.get($obj.data("url"), function(data){
                   $obj.text(data.count);
                });
            });
        });
    </script>
{% endblock %}
